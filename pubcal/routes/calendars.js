const express = require('express');
const router = express.Router();
const CalendarClient = require('../models/calendars');
const helper = require('../libs/icalGeneratorHelper');

router.get('/', (req, res) => {
    res.send('GET list of calendars');
});

router.get('/new', (req, res) => {
    res.render('calendars/new', {calendar: {}});
});

router.post('/addCalendar', (req, res) => {
    // TODO: ASSUME WE HAVE CALENDAR IN THE BODY
    let calendar = req.body.calendar;

    //TODO: check return value
    let filepath = helper.createCalendar(calendar);

    // //Construct list of subscribed users
    // calendar.users_subscribed = [];
    // //Add creator as a subscriber
    // calendar.users_subscribed.push(calendar.created_by);
    // //Add filepath generated by helper
    // calendar.filepath = filepath;

    CalendarClient.addCalendar(calendar)
        .then((result) => {
            if (result.ok) {
                res.json({"status": "success", "id": result.insertedId});
            } else {
                console.error("Failed inserting new calendar into db");
                res.json({"status": "failed"});
            }
        })
});

router.post('/searchCalendars', (req, res) => {
    let tag = req.body.tag;
    CalendarClient.searchForCalendars(tag, (result) => {
        if (!result.length) { // not found
            res.render('index_sample', {
                errors: 'no calendar matches your request'
            });
        } else {
            res.render('calendar_result_sample', {
                calendarResult: JSON.stringify(result)
            });
        }
    })
});

router.post('/updateCalendar', (req, res) => {
    // TODO: ASSUME NOW WE HAVE THE FILTER AND UPDATE
    let filter = req.body.filter;
    let update = req.body.update;
    CalendarClient.updateCalendar(filter, update)
        .then((result) => {
            if (result) {
                // TODO: RENDER SUCCESS MESSAGE
                res.render();
            }
        });
});

router.post('/removeCalendar', (req, res) => {
    // TODO: ASSUME NOW WE HAVE THE FILTER
    let filter = req.body.filter;
    CalendarClient.removeCalendar(filter)
        .then((result) => {
            if (result) {
                // TODO: RENDER SUCCESS MESSAGE
                res.render();
            }
        });
});

// GET a calendar with id
router.get('/:id', (req, res) => {
    res.send('GET calendar with id' + req.params.id);
});

module.exports = router;
